#!/usr/bin/env bash
set -ex

cd $(dirname $0)/..

source ./scripts/version.sh

./scripts/build-image-runtime

awk '{print $1}' << EOF > build/images-runtime.txt
    ${REGISTRY}/${REPO}/${PROG}-runtime:${DOCKERIZED_VERSION}
EOF

xargs -n1 -t docker image pull --quiet << EOF >> build/images-core.txt
    ${REGISTRY}/${REPO}/hardened-kubernetes:v1.19.13-rke2r2-build20210716
    docker.io/rancher/hardened-calico:v3.13.3-build20210223
    docker.io/rancher/hardened-coredns:v1.6.9-build20210223
    docker.io/rancher/hardened-etcd:v3.4.13-k3s1-build20210223
    docker.io/rancher/hardened-flannel:v0.13.0-rancher1-build20210223
    docker.io/rancher/hardened-k8s-metrics-server:v0.3.6-build20210223
    docker.io/rancher/hardened-kube-proxy:${KUBERNETES_VERSION}-build20210716
    docker.io/rancher/klipper-helm:v0.4.3-build20210225
    docker.io/rancher/pause:3.2
    docker.io/rancher/nginx-ingress-controller-defaultbackend:1.5-rancher1
    docker.io/rancher/nginx-ingress-controller:nginx-0.30.0-rancher1
EOF


# Continue to provide a legacy airgap archive set with the default CNI images
cat build/images-runtime.txt build/images-core.txt > build/images.txt
